---
layout: page
permalink: /blogs/optimalstopping/index.html
title: Optimal Stopping
---

## 【无限流浅谈】从《迷域行者》到双臂赌博机

最近在B站刷到一档神奇的综艺节目——《十天之后回归现实》，该节目的安排基本照搬自日本智斗/无限流漫画《弥留之国的爱丽丝》，大概是一群人被投放到一个“异世界”中，需要完成各种各样的游戏来获取“签证”（在异世界中的生存时间）。其中的一个游戏来自一部被尘封的国产无限流漫画——《迷域行者》，我们现在来聊聊这个游戏中有趣的设定和可能的解法。

#### 问题描述

综艺节目中给出的原始问题是这样的：

>玩家面前有一列苹果，每个苹果的质量是$m_i$。玩家只能依次看到第$i=1,2,3,\cdots,n$个苹果的重量。在玩家获知第$i$苹果的重量后，玩家可以选择拿取这个苹果，或者继续向前走；玩家一旦获知第$i$个苹果的重量，就不能拿取编号小于$i$的苹果。每个玩家在拿取两个苹果后游戏结束，两个苹果中质量最大的那个是玩家的最终得分，而玩家需要最大化一得分。

### “最优停止”问题的定义

上面的“取苹果”问题是可以被归类到最优停止问题中，这里我们先给出最优停止问题的定义：


我们有一列随机变量$\{X_i\}$和一列函数$\{y_i\}$。你可以在随机变量序列 $X_1,X_2,\cdots,X_T$ 中观测任意长度的序列，在观测到$X_i = x_i$后，你可以选择继续向下观测$X_{i+1}$，也可以选择停止以获得奖励$y_i = y(x_1,x_2,\cdots,x_i)$。记观测到$X_i$后选择停止的概率为$\phi_i$，停在第$i$步的概率为$\psi_i$，则$\psi_0 = \phi_0$，$\psi_1 = (1 - \phi_0) \cdot \phi_1$，等等。我们的目标是合理地选择$\phi_i$，以最大化收益期望$R(\phi)  = \mathbb{E} (\sum_i \psi_i y_i)$。换言之，一个更简单的定义是：我们有离散随机过程$\{Y_i\}$，$\mathcal{F}_i$是由$Y_1,Y_2,\cdots,Y_i$定义的滤流（Filtration）。我们定义随机变量$N$是一个停时，如果事件$\{N \le i\}$是$\mathcal{F}_i$可测的。我们要找到一个停时$N$，最大化$R = \mathbb{E}(Y_N)$。



### 经典最优停止问题：离散有限视野的情况

如果问题中的随机变量序列是有限的，我们就称问题是Finite Horizon（如同最优控制中一样）。这样的问题可以通过逆向归纳法（实际上是一种动态规划方法）求解。

#### 一般的套路：逆向归纳法

定义状态价值函数$V_i$，代表从第$i$阶段开始使用最优停止策略直到终点所能获取的最大期望收益。设决策阶段的总数为$T$，显然边界条件是$V_T = \mathbb{E} [y_T (x_1,x_2,\cdots,x_T)]$，$V_i$满足的递推公式是：

$$V_i(x_1,x_2,\cdots,x_i) = \max[ \mathbb{E} [y_i(x_1,x_2,\cdots,x_i) ],  V_{i+1}]$$

在第$i$步选择停止的条件是$\mathbb{E} [y_i(x_1,x_2,\cdots,x_i) ] \ge V_{i+1}$。只要从$V_T$开始倒推，一路计算到$V_0$，我们也就求出了问题的解。


#### 经典秘书问题

首先介绍一种最经典的问题。

>一位公司领导要选择秘书，领导必须依次面试每个秘书，并在每场面试结束后立刻决定是否录用。假设领导可以清晰地比较任意两个秘书之间的能力强弱，那么领导应该采取何种策略，才能最大化选到能力最佳的秘书的概率？

首先计算每个阶段的期望收益，假设秘书共有$n$位，我们将每个阶段时已经面试过的人中能力最强者称为“候选人”，那么显然有：

$$ \mathbb{E} (y_i) = \begin{cases} \dfrac{i}{n}  \quad \text{第}i\text{位面试者是候选人} \\ 0  \quad \text{第}i\text{位面试者不是候选人} \end{cases}$$

利用上面逆向归纳法中状态价值函数的递推公式，容易看出$V_i \ge V_{i+1}$，而假设第$i$阶段和第$i+1$阶段面试的秘书均为候选人，我们有$\mathbb{E} (y_i) < \mathbb{E}(y_{i+1})$，因此如果在第$i$阶段有$\mathbb{E} (y_i)  \ge  V_i$，那么在第$i+1$阶段必有$\mathbb{E} (y_{i+1})  > V_{i+1}$。这使得我们得到重要结论：**假如第$i$阶段和第$i+1$阶段面试的秘书均是“候选人”，且第$i$阶段的最优策略是录取当前的秘书，那么第$i+1$阶段的最优策略也应是录取当前的秘书**。因此，我们可以构造参数化的最优策略：**选择一个阈值$r$，拒绝第$1$个到第$r-1$个秘书，接受从$r$开始出现的第一个“候选人”**。

记$P_r$为选取阈值为$r$时，选择到最优秘书的概率，现在只需优化$P_r$。直接计算：

$$\begin{align*}P_r  &= \sum_{i=r}^n P(\text{第}i\text{位秘书能力最佳且被选择})  \\ &= \sum_{i=r}^n  P(\text{第}i\text{位秘书能力最佳}) \cdot P(\text{第}i\text{位秘书被选择}|\text{第}i\text{位秘书能力最佳})  \\  &=  P(\text{第}i\text{位秘书能力最佳}) \cdot  \sum_{i=r}^n   P(\text{前}i-1\text{位中能力最佳的秘书出现在前}r-1\text{位中}) \\ &=  \sum_{i=r}^n \dfrac{1}{n} \cdot  \dfrac{r-1}{i-1}  = \dfrac{n-1}{n} \sum_{i=r}^n \dfrac{1}{i-1}\end{align*}$$


通过检查$P_{r+1} \le P_r$的点可以得到：

$$r = \min(r \ge 1, \sum_{i=r+1}^n \dfrac{1}{i-1} \ge 1)$$

在$n$很大时，可以得到$\dfrac{r}{n} \rightarrow \dfrac{1}{e}$。


#### 效用单调的秘书问题



#### 停车场问题



### 从最优停止到强化学习：双臂赌博机的研究


